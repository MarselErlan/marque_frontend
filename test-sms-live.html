<!DOCTYPE html>
<html>
<head>
    <title>Live SMS Test - MARQUE</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="p-8 bg-gray-100">
    <div class="max-w-md mx-auto bg-white rounded-lg shadow-md p-6">
        <h1 class="text-2xl font-bold mb-4">üöÄ Live SMS Test</h1>
        <p class="text-sm text-gray-600 mb-4">Test your phone verification with the exact same code as your live site</p>
        
        <div class="mb-4">
            <label class="block mb-2 font-medium">Country Code:</label>
            <select id="countryCode" class="w-full p-3 border rounded-lg">
                <option value="+1">üá∫üá∏ +1 (US)</option>
                <option value="+996">üá∞üá¨ +996 (KG)</option>
            </select>
        </div>
        
        <div class="mb-4">
            <label class="block mb-2 font-medium">Phone Number:</label>
            <input type="tel" id="phoneNumber" placeholder="3128059851" class="w-full p-3 border rounded-lg">
        </div>
        
        <div class="mb-4 p-3 bg-blue-50 rounded-lg">
            <strong>Will send SMS to: </strong><span id="fullNumber" class="font-mono">+1</span>
        </div>
        
        <button onclick="sendSMS()" id="sendBtn" class="w-full bg-purple-500 text-white p-3 rounded-lg hover:bg-purple-600 disabled:bg-gray-400">
            –û—Ç–ø—Ä–∞–≤–∏—Ç—å SMS
        </button>
        
        <div id="smsResult" class="mt-4 hidden"></div>
        
        <!-- SMS Code Input (appears after SMS sent) -->
        <div id="smsCodeSection" class="mt-6 hidden">
            <div class="mb-4">
                <label class="block mb-2 font-medium">SMS Code:</label>
                <input type="text" id="smsCode" placeholder="123456" maxlength="6" class="w-full p-3 border rounded-lg text-center text-lg tracking-widest">
            </div>
            <button onclick="verifySMS()" id="verifyBtn" class="w-full bg-green-500 text-white p-3 rounded-lg hover:bg-green-600 disabled:bg-gray-400">
                –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∫–æ–¥
            </button>
        </div>
        
        <div id="verifyResult" class="mt-4 hidden"></div>
    </div>

    <script>
        const API_BASE = 'https://marquebackend-production.up.railway.app/api/v1';
        
        const countryCodeSelect = document.getElementById('countryCode');
        const phoneNumberInput = document.getElementById('phoneNumber');
        const fullNumberSpan = document.getElementById('fullNumber');
        const sendBtn = document.getElementById('sendBtn');
        const smsResult = document.getElementById('smsResult');
        const smsCodeSection = document.getElementById('smsCodeSection');
        const smsCodeInput = document.getElementById('smsCode');
        const verifyBtn = document.getElementById('verifyBtn');
        const verifyResult = document.getElementById('verifyResult');
        
        let currentPhoneNumber = '';
        
        function updateFullNumber() {
            const countryCode = countryCodeSelect.value;
            const phoneNumber = phoneNumberInput.value.replace(/[-\s]/g, '');
            const fullNumber = countryCode + phoneNumber;
            fullNumberSpan.textContent = fullNumber;
            currentPhoneNumber = fullNumber;
        }
        
        countryCodeSelect.addEventListener('change', updateFullNumber);
        phoneNumberInput.addEventListener('input', updateFullNumber);
        
        async function sendSMS() {
            const countryCode = countryCodeSelect.value;
            const phoneNumber = phoneNumberInput.value.replace(/[-\s]/g, '');
            const fullPhoneNumber = countryCode + phoneNumber;
            
            // Validation
            if (countryCode === '+1' && phoneNumber.length !== 10) {
                alert('–î–ª—è –Ω–æ–º–µ—Ä–æ–≤ –°–®–ê –≤–≤–µ–¥–∏—Ç–µ 10 —Ü–∏—Ñ—Ä');
                return;
            }
            if (countryCode === '+996' && phoneNumber.length !== 9) {
                alert('–î–ª—è –Ω–æ–º–µ—Ä–æ–≤ –ö–ì –≤–≤–µ–¥–∏—Ç–µ 9 —Ü–∏—Ñ—Ä');
                return;
            }
            
            sendBtn.disabled = true;
            sendBtn.textContent = '–û—Ç–ø—Ä–∞–≤–ª—è–µ–º...';
            
            smsResult.className = 'mt-4 p-4 bg-yellow-100 rounded';
            smsResult.textContent = '–û—Ç–ø—Ä–∞–≤–ª—è–µ–º SMS...';
            smsResult.classList.remove('hidden');
            
            try {
                console.log('Sending SMS to:', fullPhoneNumber);
                console.log('Market:', countryCode === '+1' ? 'us' : 'kg');
                
                const response = await fetch(API_BASE + '/auth/send-verification', {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'X-Market': countryCode === '+1' ? 'us' : 'kg',
                        'X-Request-ID': `req-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`
                    },
                    body: JSON.stringify({
                        phone: fullPhoneNumber
                    })
                });
                
                console.log('Response Status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Success:', data);
                    
                    smsResult.className = 'mt-4 p-4 bg-green-100 rounded';
                    smsResult.innerHTML = `
                        <h3 class="font-bold text-green-800">‚úÖ SMS –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!</h3>
                        <p><strong>–ù–æ–º–µ—Ä:</strong> ${data.data.phone}</p>
                        <p><strong>–ü—Ä–æ–≤–∞–π–¥–µ—Ä:</strong> ${data.data.sms_provider}</p>
                        <p><strong>–ò—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑:</strong> ${data.data.expires_in_minutes} –º–∏–Ω—É—Ç</p>
                    `;
                    smsResult.innerHTML += `<p class="text-sm mt-2">–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ SMS –Ω–∏–∂–µ:</p>`;
                    
                    smsCodeSection.classList.remove('hidden');
                    currentPhoneNumber = fullPhoneNumber;
                } else {
                    const errorText = await response.text();
                    console.error('Error:', errorText);
                    
                    smsResult.className = 'mt-4 p-4 bg-red-100 rounded';
                    smsResult.innerHTML = `
                        <h3 class="font-bold text-red-800">‚ùå –û—à–∏–±–∫–∞ ${response.status}</h3>
                        <pre class="text-sm mt-2">${errorText}</pre>
                    `;
                }
            } catch (error) {
                console.error('Network Error:', error);
                
                smsResult.className = 'mt-4 p-4 bg-red-100 rounded';
                smsResult.innerHTML = `
                    <h3 class="font-bold text-red-800">‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏</h3>
                    <p>${error.message}</p>
                `;
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å SMS';
            }
        }
        
        async function verifySMS() {
            const smsCode = smsCodeInput.value.trim();
            
            if (smsCode.length !== 6) {
                alert('–í–≤–µ–¥–∏—Ç–µ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥');
                return;
            }
            
            verifyBtn.disabled = true;
            verifyBtn.textContent = '–ü—Ä–æ–≤–µ—Ä—è–µ–º...';
            
            verifyResult.className = 'mt-4 p-4 bg-yellow-100 rounded';
            verifyResult.textContent = '–ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–¥...';
            verifyResult.classList.remove('hidden');
            
            try {
                const countryCode = countryCodeSelect.value;
                
                const response = await fetch(API_BASE + '/auth/verify-code', {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'X-Market': countryCode === '+1' ? 'us' : 'kg',
                        'X-Request-ID': `req-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                    },
                    body: JSON.stringify({
                        phone: currentPhoneNumber,
                        code: smsCode
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Verification Success:', data);
                    
                    verifyResult.className = 'mt-4 p-4 bg-green-100 rounded';
                    verifyResult.innerHTML = `
                        <h3 class="font-bold text-green-800">üéâ –£—Å–ø–µ—à–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã!</h3>
                        <p><strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong> ${data.data.user?.phone || currentPhoneNumber}</p>
                        <p><strong>–¢–æ–∫–µ–Ω:</strong> ${data.data.access_token ? '‚úÖ –ü–æ–ª—É—á–µ–Ω' : '‚ùå –ù–µ –ø–æ–ª—É—á–µ–Ω'}</p>
                        <p class="text-sm mt-2 text-green-700">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç! üéä</p>
                    `;
                    
                } else {
                    const errorText = await response.text();
                    console.error('Verification Error:', errorText);
                    
                    verifyResult.className = 'mt-4 p-4 bg-red-100 rounded';
                    verifyResult.innerHTML = `
                        <h3 class="font-bold text-red-800">‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥</h3>
                        <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –∑–∞–ø—Ä–æ—Å–∏—Ç–µ –Ω–æ–≤—ã–π SMS</p>
                    `;
                }
            } catch (error) {
                console.error('Verification Network Error:', error);
                
                verifyResult.className = 'mt-4 p-4 bg-red-100 rounded';
                verifyResult.innerHTML = `
                    <h3 class="font-bold text-red-800">‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏</h3>
                    <p>${error.message}</p>
                `;
            } finally {
                verifyBtn.disabled = false;
                verifyBtn.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∫–æ–¥';
            }
        }
        
        // Initialize
        updateFullNumber();
    </script>
</body>
</html>